<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Thống kê đánh giá</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container mt-5">
    <ul class="nav nav-tabs" id="reviewTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="table-tab" data-bs-toggle="tab" data-bs-target="#tableTab"
                    type="button" role="tab">Danh sách</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="chart-tab" data-bs-toggle="tab" data-bs-target="#chartTab"
                    type="button" role="tab">Biểu đồ cảm xúc</button>
        </li>
    </ul>
    <div class="tab-content mt-3" id="reviewTabsContent">
        <!-- Tab Bảng -->
        <div class="tab-pane fade show active" id="tableTab" role="tabpanel">
            <div class="card">
                <div class="card-header bg-dark text-white text-center">
                    <h4>Thống Kê Tất Cả Đánh Giá Nhân Viên</h4>
                </div>
                <div class="card-body">
                    <table class="table table-bordered text-center">
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <button class="btn btn-secondary" id="prevBtn">Trang Trước</button>
                            <span id="pageInfo" class="fw-bold"></span>
                            <button class="btn btn-secondary" id="nextBtn">Trang Sau</button>
                        </div>
                        <thead class="table-primary">
                        <tr>
                            <th>STT</th>
                            <th>Username</th>
                            <th>Kỳ Đánh Giá</th>
                            <th>Ngày</th>
                            <th>Kỹ Năng</th>
                            <th>Thái Độ</th>
                            <th>Hiệu Suất</th>
                            <th>Đóng Góp</th>
                            <th>Điểm TB</th>
                            <th>Nhận Xét</th>
                            <th>Cảm Xúc</th>
                        </tr>
                        </thead>
                        <tbody id="statsTableBody"></tbody>
                    </table>
                    <div class="text-center">
                        <button class="btn btn-secondary" onclick="window.location.href='index.html'">Quay Lại</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Biểu đồ -->
        <div class="tab-pane fade" id="chartTab" role="tabpanel">
            <div class="card">
                <div class="card-header bg-info text-white text-center">
                    <h4>Biểu đồ cảm xúc các đánh giá</h4>
                </div>
                <div class="card-body">
                    <canvas id="sentimentChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const employeeReviews = JSON.parse(localStorage.getItem("allEmployeeReviews")) || {};
    let allReviews = [];
    let sentimentCounts = { pos: 0, neu: 0, neg: 0 };

    for (const username in employeeReviews) {
        const reviews = employeeReviews[username];
        reviews.forEach((review) => {
            allReviews.push({
                username,
                ...review,
                avg: (review.scores.reduce((a, b) => a + b, 0) / review.scores.length).toFixed(1)
            });
        });
    }

    let currentPage = 1;
    const reviewsPerPage = 6;

    function renderTablePage(page) {
        const start = (page - 1) * reviewsPerPage;
        const end = start + reviewsPerPage;
        const paginatedReviews = allReviews.slice(start, end);

        const tableBody = document.getElementById("statsTableBody");
        tableBody.innerHTML = "";

        paginatedReviews.forEach((review, index) => {
            const row = `
            <tr>
              <td>${start + index + 1}</td>
              <td>${review.username}</td>
              <td>${review.period}</td>
              <td>${review.date}</td>
              <td>${review.scores[0]}</td>
              <td>${review.scores[1]}</td>
              <td>${review.scores[2]}</td>
              <td>${review.scores[3]}</td>
              <td>${review.avg}</td>
              <td>${review.comment}</td>
              <td class="sentiment" data-comment="${review.comment}">⏳</td>
            </tr>`;
            tableBody.innerHTML += row;
        });

        document.getElementById("pageInfo").innerText =
            `Trang ${currentPage} / ${Math.ceil(allReviews.length / reviewsPerPage)}`;
        document.getElementById("prevBtn").disabled = currentPage === 1;
        document.getElementById("nextBtn").disabled = currentPage * reviewsPerPage >= allReviews.length;

        processSentiments();
    }

    function processSentiments() {
        sentimentCounts = { pos: 0, neu: 0, neg: 0 };
        document.querySelectorAll(".sentiment").forEach(cell => {
            const comment = cell.dataset.comment;
            fetch("http://localhost:5000/analyze", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ text: comment })
            })
                .then(res => res.json())
                .then(data => {
                    const label = data.label.toLowerCase();
                    if (label.includes("pos")) {
                        cell.innerText = "Tích cực";
                        cell.classList.add("text-success");
                        sentimentCounts.pos++;
                    } else if (label.includes("neg")) {
                        cell.innerText = "Tiêu cực";
                        cell.classList.add("text-danger");
                        sentimentCounts.neg++;
                    } else {
                        cell.innerText = "Trung lập";
                        cell.classList.add("text-muted");
                        sentimentCounts.neu++;
                    }
                    updateChart();
                })
                .catch(() => {
                    cell.innerText = "Lỗi API";
                    cell.classList.add("text-warning");
                });
        });
    }

    let chart;
    function updateChart() {
        const ctx = document.getElementById("sentimentChart").getContext("2d");
        const data = {
            labels: ["Tích cực", "Trung lập", "Tiêu cực"],
            datasets: [{
                label: "Số lượng",
                data: [sentimentCounts.pos, sentimentCounts.neu, sentimentCounts.neg],
                backgroundColor: ["#28a745", "#6c757d", "#dc3545"]
            }]
        };
        if (chart) {
            chart.data.datasets[0].data = data.datasets[0].data;
            chart.update();
        } else {
            chart = new Chart(ctx, {
                type: "bar",
                data,
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            precision: 0
                        }
                    }
                }
            });
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        renderTablePage(currentPage);
        document.getElementById("prevBtn").addEventListener("click", function () {
            if (currentPage > 1) {
                currentPage--;
                renderTablePage(currentPage);
            }
        });
        document.getElementById("nextBtn").addEventListener("click", function () {
            if (currentPage * reviewsPerPage < allReviews.length) {
                currentPage++;
                renderTablePage(currentPage);
            }
        });
    });
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
