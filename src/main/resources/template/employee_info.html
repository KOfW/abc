<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Thông Tin Nhân Viên</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
    />
    <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }

        .card {
            border-radius: 15px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .card-header {
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-danger,
        .btn-primary,
        .btn-success {
            transition: 0.3s;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-success:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <div class="card">
        <div class="card-header bg-dark text-white text-center">
            <h4><i class="bi bi-person-badge"></i> Thông Tin Nhân Viên</h4>
        </div>
        <div class="card-body">
            <h5 id="fullname"><i class="bi bi-person-fill"></i> Họ và Tên:</h5>
            <p id="username"><i class="bi bi-person"></i> Username:</p>
            <p id="role"><i class="bi bi-briefcase-fill"></i> Chức Vụ:</p>
            <p id="department"><i class="bi bi-building"></i> Phòng Ban:</p>

            <h5 class="mt-4">
                <i class="bi bi-clipboard-check"></i> Lịch Sử Đánh Giá
            </h5>

            <div id="reviewSections"></div>
            <div class="text-center mt-3">
                <button id="prevPage" class="btn btn-secondary me-2">
                    <i class="bi bi-arrow-left"></i> Trang trước
                </button>
                <button id="nextPage" class="btn btn-secondary">
                    <i class="bi bi-arrow-right"></i> Trang sau
                </button>
            </div>

            <div class="text-center mt-4">
                <button
                        class="btn btn-secondary px-4"
                        onclick="window.location.href='listEmployee.html'"
                >
                    <i class="bi bi-arrow-left"></i> Quay Lại
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Dữ liệu đánh giá mẫu
    // const reviewData = [
    //     {
    //         period: "T3/2024",
    //         date: "2024-03-21",
    //         scores: [8, 9, 7, 8],
    //         comment: "Nhân viên làm việc tốt",
    //     },
    //     {
    //         period: "T3/2025",
    //         date: "2025-03-15",
    //         scores: [9, 8, 8, 9],
    //         comment: "Nhân viên có sự tiến bộ",
    //     },
    //     {
    //         period: "T4/2025",
    //         date: "2025-04-10",
    //         scores: [7, 8, 7, 7],
    //         comment: "Cần cải thiện hiệu suất",
    //     },
    //     {
    //         period: "T5/2025",
    //         date: "2025-05-05",
    //         scores: [8, 9, 8, 9],
    //         comment: "Thể hiện tốt trong dự án mới",
    //     },
    //     {
    //         period: "T6/2025",
    //         date: "2025-06-12",
    //         scores: [9, 9, 9, 9],
    //         comment: "Xuất sắc, cần duy trì phong độ",
    //     },
    //     {
    //         period: "T7/2025",
    //         date: "2025-07-20",
    //         scores: [8, 8, 8, 8],
    //         comment: "Làm việc ổn định",
    //     },
    //     {
    //         period: "T8/2025",
    //         date: "2025-08-18",
    //         scores: [9, 9, 10, 9],
    //         comment: "Hiệu suất rất tốt",
    //     },
    // ];
    const stored = localStorage.getItem("selectedReviews");
    const reviewData = stored ? JSON.parse(stored) : [];

    function createReviewCard(index, data) {
        let avgScore = (
            data.scores.reduce((a, b) => a + b, 0) / data.scores.length
        ).toFixed(1);
        let reviewId = `review${index}`;

        return `
    <div class="card" id="${reviewId}">
      <div class="card-header bg-secondary text-white">
        Đánh giá ${data.period} - ${data.date}
        <div>
          <button class="btn btn-primary btn-sm" onclick="editReview('${reviewId}')"><i class="bi bi-pencil"></i></button>
          <button class="btn btn-success btn-sm" onclick="saveReview('${reviewId}')" disabled><i class="bi bi-save"></i></button>
          <button class="btn btn-danger btn-sm" onclick="deleteReview('${reviewId}')"><i class="bi bi-trash"></i></button>
        </div>
      </div>
      <div class="card-body">
        <table class="table table-bordered text-center">
          <tbody>
            <tr><th>Kỹ Năng</th><td><input type="number" class="score form-control" value="${data.scores[0]}" disabled></td></tr>
            <tr><th>Thái Độ</th><td><input type="number" class="score form-control" value="${data.scores[1]}" disabled></td></tr>
            <tr><th>Hiệu Suất</th><td><input type="number" class="score form-control" value="${data.scores[2]}" disabled></td></tr>
            <tr><th>Đóng Góp</th><td><input type="number" class="score form-control" value="${data.scores[3]}" disabled></td></tr>
            <tr class="table-primary"><th>Điểm Trung Bình</th><td id="avgScore">${avgScore}</td></tr>
            <tr class="table-warning"><th>Nhận Xét</th><td contenteditable="false">${data.comment}</td></tr>
          </tbody>
        </table>
      </div>
    </div>`;
    }

    function deleteReview(reviewId) {
        // Xác nhận hành động xóa
        if (confirm("Bạn có chắc chắn muốn xóa đánh giá này không?")) {
            // Tìm và xóa phần tử trong mảng dữ liệu reviewData
            let index = reviewData.findIndex(
                (review) => "review" + (reviewData.indexOf(review) + 1) === reviewId
            );
            if (index !== -1) {
                // Xóa phần tử khỏi mảng reviewData
                reviewData.splice(index, 1);

                // Xóa phần tử khỏi giao diện
                let reviewCard = document.getElementById(reviewId);
                reviewCard.remove();

                alert("Đánh giá đã được xóa thành công!");
            }
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        let reviewSections = document.getElementById("reviewSections");
        // Hiển thị chỉ 5 đánh giá mới nhất
        let limitedReviewData = reviewData.slice(0, 5);

        limitedReviewData.forEach((review, index) => {
            reviewSections.innerHTML += createReviewCard(index + 1, review);
        });

        let selects = document.getElementsByClassName("score");
        for (let select of selects) {
            for (let i = 0; i <= 10; i++) {
                let option = document.createElement("option");
                option.value = i;
                option.textContent = i;
                select.appendChild(option);
            }
            select.value = 8;
        }

        // Gán sự kiện thay đổi điểm để cập nhật điểm trung bình
        document.querySelectorAll(".score").forEach((select) => {
            select.addEventListener("change", function () {
                let reviewId = this.closest(".card").id;
                updateAverageScore(reviewId);
            });
        });
    });

    function editReview(reviewId) {
        let reviewCard = document.getElementById(reviewId);
        let commentCell = reviewCard.querySelector("tr.table-warning td");
        let scoreInputs = reviewCard.querySelectorAll(".score");
        let editBtn = reviewCard.querySelector(".btn-primary");
        let saveBtn = reviewCard.querySelector(".btn-success");

        // Bật chế độ chỉnh sửa
        commentCell.contentEditable = "true";
        scoreInputs.forEach((input) => {
            input.disabled = false;
            input.min = 0;
            input.max = 10;
        });

        // Hiển thị nút Lưu, ẩn nút Sửa
        editBtn.disabled = true;
        saveBtn.disabled = false;
    }

    function saveReview(reviewId) {
        let reviewCard = document.getElementById(reviewId);
        let commentCell = reviewCard.querySelector("tr.table-warning td");
        let scoreInputs = reviewCard.querySelectorAll(".score");
        let editBtn = reviewCard.querySelector(".btn-primary");
        let saveBtn = reviewCard.querySelector(".btn-success");

        // Tắt chế độ chỉnh sửa
        commentCell.contentEditable = "false";
        scoreInputs.forEach((input) => (input.disabled = true));

        // Cập nhật điểm trung bình mới
        updateAverageScore(reviewId);

        // Hiển thị nút Sửa, ẩn nút Lưu
        editBtn.disabled = false;
        saveBtn.disabled = true;
    }

    function updateAverageScore(reviewId) {
        let reviewCard = document.getElementById(reviewId);
        let scoreInputs = reviewCard.querySelectorAll(".score");
        let totalScore = 0;
        let validScores = true;

        scoreInputs.forEach((input) => {
            let score = parseInt(input.value);
            if (score < 0 || score > 10 || isNaN(score)) {
                validScores = false;
            }
            totalScore += score;
        });

        if (validScores) {
            let avgScore = (totalScore / scoreInputs.length).toFixed(1);
            reviewCard.querySelector("#avgScore").textContent = avgScore;
        } else {
            alert("Điểm số phải nằm trong khoảng từ 0 đến 10!");
        }
    }

    // Lấy thông tin nhân viên từ URL
    const urlParams = new URLSearchParams(window.location.search);
    const username = urlParams.get("user");

    const employees = [
        {
            username: "user1",
            fullName: "Nguyễn Văn A",
            role: "Admin",
            department: "Hành Chính",
        },
        {
            username: "user2",
            fullName: "Trần Thị B",
            role: "Nhân Viên",
            department: "Nhân Sự",
        },
        {
            username: "user3",
            fullName: "Lê Văn C",
            role: "Nhân Viên",
            department: "Hậu Cần",
        },
        {
            username: "user4",
            fullName: "Phạm Văn D",
            role: "Nhân Viên",
            department: "Kế Toán",
        },
        {
            username: "user5",
            fullName: "Hoàng Thị E",
            role: "Nhân Viên",
            department: "Kinh Doanh",
        },
        {
            username: "user6",
            fullName: "Đỗ Văn F",
            role: "Admin",
            department: "IT",
        },
        {
            username: "user7",
            fullName: "Bùi Thị G",
            role: "Nhân Viên",
            department: "Marketing",
        },
    ];

    // Tìm nhân viên theo username và hiển thị thông tin
    const employee = employees.find((emp) => emp.username === username);

    if (employee) {
        document.getElementById("fullname").innerText =
            "Họ và Tên: " + employee.fullName;
        document.getElementById("username").innerText =
            "Username: " + employee.username;
        document.getElementById("role").innerText = "Chức Vụ: " + employee.role;
        document.getElementById("department").innerText =
            "Phòng Ban: " + employee.department;
    }
    //phân trang
    const reviewsPerPage = 3; // Số đánh giá mỗi trang
    let currentPage = 1;

    function displayReviews(page) {
        let reviewSections = document.getElementById("reviewSections");
        reviewSections.innerHTML = ""; // Xóa nội dung cũ

        let startIndex = (page - 1) * reviewsPerPage;
        let endIndex = startIndex + reviewsPerPage;
        let limitedReviewData = reviewData.slice(startIndex, endIndex);

        limitedReviewData.forEach((review, index) => {
            reviewSections.innerHTML += createReviewCard(
                startIndex + index + 1,
                review
            );
        });

        updatePaginationButtons();
    }

    function updatePaginationButtons() {
        document.getElementById("prevPage").disabled = currentPage === 1;
        document.getElementById("nextPage").disabled =
            currentPage * reviewsPerPage >= reviewData.length;
    }

    // Chuyển trang trước
    document
        .getElementById("prevPage")
        .addEventListener("click", function () {
            if (currentPage > 1) {
                currentPage--;
                displayReviews(currentPage);
            }
        });

    // Chuyển trang sau
    document
        .getElementById("nextPage")
        .addEventListener("click", function () {
            if (currentPage * reviewsPerPage < reviewData.length) {
                currentPage++;
                displayReviews(currentPage);
            }
        });

    // Hiển thị trang đầu tiên khi tải trang
    document.addEventListener("DOMContentLoaded", function () {
        displayReviews(currentPage);
    });
</script>
</body>
</html>
